// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// ==========================
// Prisma Configuration
// ==========================

generator client {
  provider     = "prisma-client"
  output       = "./generated"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

// ==========================
// TENANT (Education Center)
// ==========================
model Tenant {
  id        String   @id @default(cuid())
  name      String
  subdomain String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  users     User[]
  schedules ExamSchedule[]
}

// ==========================
// USER & ROLES
// ==========================
enum UserRole {
  OWNER // Platform admin
  TENANT // Center admin
  STAFF // Proctors / staff
  STUDENT // Student / scheduled test user
}

model User {
  id        String     @id @default(cuid())
  tenantId  String?
  email     String     @unique
  password  String
  name      String
  roles     UserRole[]
  createdAt DateTime   @default(now())

  tenant Tenant? @relation(fields: [tenantId], references: [id])
}

// ==========================
// EXAM SCHEDULE (Proctored Practice Test)
// ==========================
enum ExamScheduleStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
}

model ExamSchedule {
  id        String             @id @default(cuid())
  tenantId  String
  testId    String // e.g., "test1"
  name      String?
  startTime DateTime
  endTime   DateTime?
  status    ExamScheduleStatus @default(SCHEDULED)

  tenant   Tenant        @relation(fields: [tenantId], references: [id])
  seats    ExamSeat[]
  attempts SeatAttempt[]
}

model ExamSeat {
  id                  String @id @default(cuid())
  scheduleId          String
  seatNumber          Int
  label               String // e.g., "Row 3, Seat 2"
  accessCode          String @unique // ← UNIQUE per seat! e.g., "A3K9P2"
  assignedStudentName String // ← Teacher fills: "Ahmed Khan"
  assignedStudentId   String // Optional school ID

  schedule ExamSchedule @relation(fields: [scheduleId], references: [id])
  attempt  SeatAttempt?

  @@unique([scheduleId, seatNumber])
  @@unique([scheduleId, accessCode]) // Ensures no duplicate codes in same schedule
}

model SeatAttempt {
  id          String        @id @default(cuid())
  seatId      String        @unique
  scheduleId  String
  status      AttemptStatus @default(NOT_STARTED)
  startedAt   DateTime?
  submittedAt DateTime?

  seat     ExamSeat         @relation(fields: [seatId], references: [id])
  schedule ExamSchedule     @relation(fields: [scheduleId], references: [id])
  sections SectionAttempt[]
}

enum AttemptStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
  EXPIRED
}

// ==========================
// SECTION ATTEMPT (Listening, Reading, etc.)
// ==========================
enum TestSection {
  LISTENING
  READING
  WRITING
  SPEAKING
}

model SectionAttempt {
  id            String        @id @default(cuid())
  seatAttemptId String
  section       TestSection
  startedAt     DateTime?
  remainingSec  Int? // For countdown sync
  status        AttemptStatus @default(NOT_STARTED)

  seatAttempt SeatAttempt       @relation(fields: [seatAttemptId], references: [id])
  questions   QuestionAttempt[]

  @@unique([seatAttemptId, section])
}

// ==========================
// QUESTION ATTEMPT
// ==========================
model QuestionAttempt {
  id               String    @id @default(cuid())
  sectionAttemptId String
  questionId       String // External ID from JSON, e.g., "Q1", "Q14"
  isFlagged        Boolean   @default(false)
  visitedAt        DateTime?

  sectionAttempt SectionAttempt @relation(fields: [sectionAttemptId], references: [id])
  answer         Answer?
  highlights     Highlight[]
  writingDrafts  WritingDraft[]

  @@unique([sectionAttemptId, questionId])
}

// ==========================
// ANSWER (User's response)
// ==========================
model Answer {
  id                String   @id @default(cuid())
  questionAttemptId String   @unique
  value             String // Text input, selected option key(s) as JSON string, etc.
  wordCount         Int?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  questionAttempt QuestionAttempt @relation(fields: [questionAttemptId], references: [id])
}

// ==========================
// HIGHLIGHT (For Reading questions)
// ==========================
model Highlight {
  id                String @id @default(cuid())
  questionAttemptId String
  startOffset       Int
  endOffset         Int
  color             String @default("yellow")

  questionAttempt QuestionAttempt @relation(fields: [questionAttemptId], references: [id])
}

// ==========================
// WRITING DRAFT (Task 1 & 2 autosave)
// ==========================
model WritingDraft {
  id                String   @id @default(cuid())
  questionAttemptId String
  content           String
  wordCount         Int
  savedAt           DateTime @default(now())

  questionAttempt QuestionAttempt @relation(fields: [questionAttemptId], references: [id])
}
